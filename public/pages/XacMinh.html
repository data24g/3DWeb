<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ki·ªÉm Tra Email L·ª´a ƒê·∫£o - B·∫£oV·ªá</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="styles.css" rel="stylesheet">
</head>

<body>
    <!-- Header -->
    <header>
        <nav class="container">
            <div class="logo">
                <a href="HomePage.html"><img src="../img/logo_btec.png" alt="BTEC FPT Education Logo"></a>
            </div>
            <ul class="nav-links">
                <li><a href="HomePage.html#home">Trang Ch·ªß</a></li>
                <li><a href="HomePage.html#features">T√≠nh NƒÉng</a></li>
                <li><a href="HomePage.html#tips">M·∫πo An To√†n</a></li>
                <li><a href="HomePage.html#report">B√°o C√°o</a></li>
                <li><a href="HomePage.html#contact">Li√™n H·ªá</a></li>
            </ul>
        </nav>
    </header>

    <!-- Hero Section -->
    <section class="hero">
        <div class="container">
            <h1><i class="fas fa-envelope-open"></i> Ki·ªÉm Tra Email L·ª´a ƒê·∫£o</h1>
            <p>Nh·∫≠p th√¥ng tin email ƒë·ªÉ ph√¢n t√≠ch v√† ph√°t hi·ªán c√°c d·∫•u hi·ªáu l·ª´a ƒë·∫£o</p>
        </div>
    </section>

    <!-- Main Content -->
    <div class="main-content">
        <div class="container">
            <!-- Form Container -->
            <div class="form-container">
                <div class="form-header">
                    <h3><i class="fas fa-envelope"></i> N·ªôi Dung Email</h3>
                    <a href="view_incoming_emails.php" class="btn-view-reports">
                        <i class="fas fa-list-alt"></i> Xem c√°c b√°o c√°o
                    </a>
                </div>
                <form id="emailCheckForm">
                    <!-- Email Content Section -->
                    <div class="form-section">

                        <div class="form-group">
                            <label for="senderEmail">Email Ng∆∞·ªùi G·ª≠i:</label>
                            <input type="email" id="senderEmail" class="form-control" placeholder="example@domain.com"
                                required>
                        </div>

                        <!-- <div class="form-group">
                            <label for="senderName">T√™n Ng∆∞·ªùi G·ª≠i:</label>
                            <input type="text" id="senderName" class="form-control" placeholder="T√™n ng∆∞·ªùi g·ª≠i">
                        </div> -->

                        <div class="form-group">
                            <label for="subject">Ti√™u ƒê·ªÅ Email:</label>
                            <input type="text" id="subject" class="form-control" placeholder="Ti√™u ƒë·ªÅ email" required>
                        </div>

                        <div class="form-group">
                            <label for="emailContent">N·ªôi Dung Email:</label>
                            <textarea id="emailContent" class="form-control"
                                placeholder="Nh·∫≠p n·ªôi dung email c·∫ßn ki·ªÉm tra..." required></textarea>
                        </div>
                    </div>

                    <!-- Button Group -->
                    <div class="button-group">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search"></i> Ki·ªÉm Tra Ngay
                        </button>
                        <button type="reset" class="btn btn-secondary">
                            <i class="fas fa-undo"></i> L√†m M·ªõi
                        </button>
                    </div>
                </form>

                <!-- Loading -->
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>ƒêang ph√¢n t√≠ch email...</p>
                </div>

                <!-- Results Section -->
                <div class="results-section" id="resultsSection">
                    <div class="result-card" id="resultCard">
                        <div class="result-header">
                            <div class="result-icon" id="resultIcon">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div>
                                <div class="result-title" id="resultTitle">K·∫øt Qu·∫£ Ph√¢n T√≠ch</div>
                                <div class="result-description" id="resultDescription">Ph√¢n t√≠ch chi ti·∫øt v·ªÅ email c·ªßa
                                    b·∫°n</div>
                            </div>
                        </div>

                        <div class="risk-factors" id="riskFactors">
                            <!-- Risk factors will be populated here -->
                        </div>

                        <div class="button-group" style="margin-top: 2rem;">
                            <button class="btn btn-success" onclick="reportPhishing()">
                                <i class="fas fa-flag"></i> B√°o C√°o L·ª´a ƒê·∫£o
                            </button>
                            <button class="btn btn-warning" onclick="saveReport()">
                                <i class="fas fa-save"></i> L∆∞u B√°o C√°o
                            </button>
                            <button class="btn btn-secondary" onclick="resetForm()">
                                <i class="fas fa-redo"></i> Ki·ªÉm Tra Email Kh√°c
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tips Section -->
            <div class="tips-section">
                <h3><i class="fas fa-lightbulb"></i> M·∫πo Nh·∫≠n Di·ªán Email L·ª´a ƒê·∫£o</h3>

                <div class="tip-item">
                    <div class="tip-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div>
                        <strong>Ki·ªÉm tra ƒë·ªãa ch·ªâ email ng∆∞·ªùi g·ª≠i:</strong> Email l·ª´a ƒë·∫£o th∆∞·ªùng c√≥ ƒë·ªãa ch·ªâ g·ª≠i gi·∫£ m·∫°o
                        ho·∫∑c kh√¥ng ch√≠nh x√°c.
                    </div>
                </div>

                <div class="tip-item">
                    <div class="tip-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div>
                        <strong>Ch√∫ √Ω ƒë·∫øn t√≠nh kh·∫©n c·∫•p:</strong> Email l·ª´a ƒë·∫£o th∆∞·ªùng t·∫°o c·∫£m gi√°c kh·∫©n c·∫•p ƒë·ªÉ b·∫°n h√†nh
                        ƒë·ªông ngay l·∫≠p t·ª©c.
                    </div>
                </div>

                <div class="tip-item">
                    <div class="tip-icon">
                        <i class="fas fa-link"></i>
                    </div>
                    <div>
                        <strong>Ki·ªÉm tra c√°c li√™n k·∫øt:</strong> Di chu·ªôt qua c√°c li√™n k·∫øt ƒë·ªÉ xem URL th·ª±c t·∫ø tr∆∞·ªõc khi
                        nh·∫•p v√†o.
                    </div>
                </div>

                <div class="tip-item">
                    <div class="tip-icon">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                    <div>
                        <strong>C·∫©n th·∫≠n v·ªõi y√™u c·∫ßu ti·ªÅn:</strong> Email y√™u c·∫ßu chuy·ªÉn ti·ªÅn ho·∫∑c cung c·∫•p th√¥ng tin
                        t√†i ch√≠nh th∆∞·ªùng l√† l·ª´a ƒë·∫£o.
                    </div>
                </div>

                <div class="tip-item">
                    <div class="tip-icon">
                        <i class="fas fa-user-secret"></i>
                    </div>
                    <div>
                        <strong>Kh√¥ng chia s·∫ª th√¥ng tin c√° nh√¢n:</strong> Ng√¢n h√†ng v√† c√°c t·ªï ch·ª©c ch√≠nh th·ª©c kh√¥ng bao
                        gi·ªù y√™u c·∫ßu th√¥ng tin qua email.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // FIX: Paste the patterns directly here to avoid module conflicts.
        const EMAIL_PATTERNS = {
            spam: {
                basic: {
                    titlePatterns: [/GI·∫¢M GI√Å.*[0-9]{2,}%/i, /CH·ªà.*H√îM NAY/i, /KHUY·∫æN M√ÉI.*KH·ª¶NG/i, /üí∞|üéâ|üî•|‚≠ê|üíØ/, /!!!/, /\$\$\$/, /CLICK.*NGAY/i, /FREE|MI·ªÑN PH√ç.*100%/i],
                    contentPatterns: [/gi·∫£m gi√°.*[789][0-9]%/i, /ch·ªâ c√≤n.*[0-9]+.*gi·ªù/i, /click.*ngay.*link/i, /bit\\.ly|tinyurl|short\\.link/, /!!!|üí∞üí∞üí∞/],
                    fromDomainPatterns: [/promo|deals|sale|offer|discount/i, /\d{2,}\\.net|\\.tk|\\.ml/]
                }
            },
            phishing: {
                basic: {
                    titlePatterns: [/b·∫£o m·∫≠t|security/i, /t√†i kho·∫£n.*b·ªã.*kh√≥a/i, /x√°c (minh|nh·∫≠n|th·ª±c).*kh·∫©n/i, /c·∫≠p nh·∫≠t.*ngay/i],
                    contentPatterns: [/t√†i kho·∫£n.*s·∫Ω b·ªã.*kh√≥a/i, /x√°c (minh|nh·∫≠n).*trong.*[0-9]+.*gi·ªù/i, /click.*link.*x√°c (minh|nh·∫≠n)/i, /c·∫≠p nh·∫≠t.*th√¥ng tin.*b·∫£o m·∫≠t/i],
                    fromDomainPatterns: [/[0-9]/, /-verification|-security|-account/i, /\\.tk|\\.ml|\\.ga|\\.cf/],
                    brandSpoofing: [/amaz[0o]n/i, /g[0o]{2}gle/i, /micr[0o]soft/i, /payp[a@]l/i, /faceb[0o]{2}k/i]
                }
            },
            suspicious: {
                basic: {
                    titlePatterns: [/kh·∫©n|g·∫•p|urgent/i, /h·∫°n ch√≥t|deadline/i, /quan tr·ªçng.*c·∫≠p nh·∫≠t/i],
                    contentPatterns: [/vui l√≤ng.*cung c·∫•p/i, /x√°c nh·∫≠n.*th√¥ng tin/i, /truy c·∫≠p.*link.*b√™n d∆∞·ªõi/i, /trong v√≤ng.*[0-9]+.*gi·ªù/i],
                    fromDomainPatterns: [/\\.(info|click|site|online)$/i, /-system|-admin/i]
                }
            },
            safe: {
                requiredPatterns: {
                    fromDomainPatterns: [/@fpt\\.edu\\.vn$/, /@[a-z]+\\.edu\\.vn$/, /@(gmail|outlook|yahoo)\\.com$/, /@[a-z]+(corp|company|university)\\.(com|vn|edu)$/]
                }
            }
        };

        // The classifier logic that uses the patterns above.
        function classifyEmail(email) {
            const { title, content, from_email } = email;

            // 1. Ki·ªÉm tra Phishing
            const phishingCheck = checkPhishing(title, content, from_email);
            if (phishingCheck.isPhishing) {
                return { category: 'Gi·∫£ m·∫°o', confidence: phishingCheck.confidence, indicators: phishingCheck.indicators };
            }

            // 2. Ki·ªÉm tra Spam
            const spamCheck = checkSpam(title, content, from_email);
            if (spamCheck.isSpam) {
                return { category: 'Spam', confidence: spamCheck.confidence, indicators: spamCheck.indicators };
            }

            // 3. Ki·ªÉm tra Nghi ng·ªù
            const suspiciousCheck = checkSuspicious(title, content, from_email);
            if (suspiciousCheck.isSuspicious) {
                return { category: 'Nghi ng·ªù', confidence: suspiciousCheck.confidence, indicators: suspiciousCheck.indicators };
            }

            // 4. Ki·ªÉm tra An to√†n
            const safeCheck = checkSafe(title, content, from_email);
            if (safeCheck.isSafe) {
                return { category: 'An to√†n', confidence: safeCheck.confidence, indicators: ['Email t·ª´ ngu·ªìn tin c·∫≠y', 'Kh√¥ng c√≥ d·∫•u hi·ªáu ƒë√°ng ng·ªù'] };
            }

            return { category: 'Nghi ng·ªù', confidence: 0.3, indicators: ['Kh√¥ng th·ªÉ x√°c ƒë·ªãnh r√µ r√†ng'] };
        }

        function checkPhishing(title, content, from_email) {
            const patterns = EMAIL_PATTERNS.phishing.basic;
            const indicators = [];
            let matchCount = 0;
            const domain = from_email.split('@')[1] || '';
            for (const brandPattern of patterns.brandSpoofing) { if (brandPattern.test(from_email) || brandPattern.test(content)) { indicators.push('Gi·∫£ m·∫°o th∆∞∆°ng hi·ªáu'); matchCount += 2; } }
            for (const phishDomain of patterns.fromDomainPatterns) { if (phishDomain.test(domain)) { indicators.push(`Domain ƒë√°ng ng·ªù: ${domain}`); matchCount += 2; } }
            for (const pattern of patterns.titlePatterns) { if (pattern.test(title)) { indicators.push('Ti√™u ƒë·ªÅ c√≥ d·∫•u hi·ªáu phishing'); matchCount++; } }
            for (const pattern of patterns.contentPatterns) { if (pattern.test(content)) { indicators.push('N·ªôi dung y√™u c·∫ßu x√°c minh kh·∫©n c·∫•p'); matchCount++; } }
            const confidence = Math.min(matchCount * 0.25, 1);
            return { isPhishing: matchCount >= 2, confidence, indicators };
        }

        function checkSpam(title, content, from_email) {
            const patterns = EMAIL_PATTERNS.spam.basic;
            const indicators = [];
            let matchCount = 0;
            const domain = from_email.split('@')[1] || '';
            for (const pattern of patterns.titlePatterns) { if (pattern.test(title)) { indicators.push('Ti√™u ƒë·ªÅ spam (gi·∫£m gi√°, emoji,...)'); matchCount++; } }
            for (const pattern of patterns.contentPatterns) { if (pattern.test(content)) { if (/bit\\.ly|tinyurl/.test(content)) { indicators.push('Ch·ª©a link r√∫t g·ªçn'); matchCount += 2; } else { indicators.push('N·ªôi dung spam ƒëi·ªÉn h√¨nh'); matchCount++; } } }
            for (const pattern of patterns.fromDomainPatterns) { if (pattern.test(domain)) { indicators.push('Domain spam th∆∞∆°ng m·∫°i'); matchCount++; } }
            const confidence = Math.min(matchCount * 0.3, 1);
            return { isSpam: matchCount >= 2, confidence, indicators };
        }

        function checkSuspicious(title, content, from_email) {
            const patterns = EMAIL_PATTERNS.suspicious.basic;
            const indicators = [];
            let matchCount = 0;
            const domain = from_email.split('@')[1] || '';
            for (const pattern of patterns.titlePatterns) { if (pattern.test(title)) { indicators.push('T·∫°o √°p l·ª±c th·ªùi gian'); matchCount++; } }
            for (const pattern of patterns.contentPatterns) { if (pattern.test(content)) { indicators.push('Y√™u c·∫ßu cung c·∫•p th√¥ng tin'); matchCount++; } }
            for (const pattern of patterns.fromDomainPatterns) { if (pattern.test(domain)) { indicators.push(`Domain kh√¥ng ch√≠nh th·ª©c: ${domain}`); matchCount++; } }
            const confidence = Math.min(matchCount * 0.35, 1);
            return { isSuspicious: matchCount >= 2, confidence, indicators };
        }

        function checkSafe(title, content, from_email) {
            const patterns = EMAIL_PATTERNS.safe.requiredPatterns;
            let isSafe = false;
            // Ch·ªâ c·∫ßn t√™n mi·ªÅn an to√†n l√† ƒë·ªß
            for (const pattern of patterns.fromDomainPatterns) {
                if (pattern.test(from_email)) {
                    isSafe = true;
                    break;
                }
            }
            return { isSafe: isSafe, confidence: isSafe ? 0.9 : 0 };
        }

        // --- DOM Elements ---
        const form = document.getElementById('emailCheckForm');
        const loadingDiv = document.getElementById('loading');
        const resultsSection = document.getElementById('resultsSection');
        const resultCard = document.getElementById('resultCard');
        const resultIcon = document.getElementById('resultIcon');
        const resultTitle = document.getElementById('resultTitle');
        const resultDescription = document.getElementById('resultDescription');
        const riskFactors = document.getElementById('riskFactors');

        // --- Global state to hold current report data ---
        let currentReportData = null;

        // --- Event Listener ---
        form.addEventListener('submit', function (event) {
            event.preventDefault();

            // 1. Get user input
            const emailData = {
                from_email: document.getElementById('senderEmail').value,
                title: document.getElementById('subject').value,
                content: document.getElementById('emailContent').value,
            };

            // 2. Show loading and hide form
            form.style.display = 'none';
            loadingDiv.style.display = 'flex';
            resultsSection.style.display = 'none';

            // 3. Simulate analysis and classify
            setTimeout(() => {
                const result = classifyEmail(emailData);

                // Store data for saving later
                currentReportData = {
                    sender_email: emailData.from_email,
                    subject: emailData.title,
                    content: emailData.content,
                    classification: result.category
                };

                // 4. Update UI with results
                updateResultsUI(result);

                // 5. Hide loading and show results
                loadingDiv.style.display = 'none';
                resultsSection.style.display = 'block';
            }, 1500); // Simulate network/analysis delay
        });

        // --- UI Update Function ---
        function updateResultsUI(result) {
            // Reset previous state
            resultCard.className = 'result-card';
            riskFactors.innerHTML = '';

            // Update content based on category
            resultTitle.textContent = result.category;
            resultDescription.textContent = `ƒê·ªô tin c·∫≠y: ${(result.confidence * 100).toFixed(0)}%`;

            let iconClass = 'fas fa-shield-alt';
            let cardClass = 'safe';

            switch (result.category) {
                case 'Gi·∫£ m·∫°o':
                    iconClass = 'fas fa-skull-crossbones';
                    cardClass = 'phishing';
                    break;
                case 'Spam':
                    iconClass = 'fas fa-ad';
                    cardClass = 'spam';
                    break;
                case 'Nghi ng·ªù':
                    iconClass = 'fas fa-question-circle';
                    cardClass = 'suspicious';
                    break;
            }
            resultIcon.innerHTML = `<i class="${iconClass}"></i>`;
            resultCard.classList.add(cardClass);

            // Populate indicators
            if (result.indicators && result.indicators.length > 0) {
                const list = document.createElement('ul');
                result.indicators.forEach(text => {
                    const listItem = document.createElement('li');
                    listItem.textContent = text;
                    list.appendChild(listItem);
                });
                riskFactors.appendChild(list);
            }
        }

        // --- Global functions for buttons ---
        window.resetForm = function () {
            form.reset();
            currentReportData = null;
            form.style.display = 'block';
            resultsSection.style.display = 'none';
        }
        window.reportPhishing = function () {
            alert('C·∫£m ∆°n b·∫°n ƒë√£ b√°o c√°o! Th√¥ng tin ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn qu·∫£n tr·ªã vi√™n.');
        }
        window.saveReport = async function () {
            if (!currentReportData) {
                alert('Kh√¥ng c√≥ d·ªØ li·ªáu b√°o c√°o ƒë·ªÉ l∆∞u.');
                return;
            }

            try {
                const response = await fetch('save_report.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(currentReportData),
                });

                const result = await response.json();

                if (response.ok) {
                    alert('L∆∞u th√†nh c√¥ng!\n' + result.message);
                } else {
                    throw new Error(result.message || 'C√≥ l·ªói x·∫£y ra t·ª´ server.');
                }
            } catch (error) {
                console.error('L·ªói khi l∆∞u b√°o c√°o:', error);
                alert('L·ªói khi l∆∞u b√°o c√°o: ' + error.message);
            }
        }

    </script>
</body>

</html>